import { assert } from '@glimmer/util';
import { Stack, DictSet } from '@glimmer/util';
import { Ops, isFlushElement, isArgument, isAttribute } from '@glimmer/wire-format';
export class Block {
    constructor() {
        this.statements = [];
    }
    push(statement) {
        this.statements.push(statement);
    }
}
export class InlineBlock extends Block {
    constructor(table) {
        super();
        this.table = table;
    }
    toJSON() {
        return {
            statements: this.statements,
            parameters: this.table.slots
        };
    }
}
export class TemplateBlock extends Block {
    constructor(symbolTable) {
        super();
        this.symbolTable = symbolTable;
        this.type = 'template';
        this.yields = new DictSet();
        this.named = new DictSet();
        this.blocks = [];
        this.hasEval = false;
    }
    push(statement) {
        this.statements.push(statement);
    }
    toJSON() {
        return {
            symbols: this.symbolTable.symbols,
            statements: this.statements,
            hasEval: this.hasEval
        };
    }
}
export class ComponentBlock extends Block {
    constructor(tag, table, selfClosing) {
        super();
        this.tag = tag;
        this.table = table;
        this.selfClosing = selfClosing;
        this.attributes = [];
        this.arguments = [];
        this.inParams = true;
        this.positionals = [];
    }
    push(statement) {
        if (this.inParams) {
            if (isFlushElement(statement)) {
                this.inParams = false;
            } else if (isArgument(statement)) {
                this.arguments.push(statement);
            } else if (isAttribute(statement)) {
                this.attributes.push(statement);
            } else {
                throw new Error('Compile Error: only parameters allowed before flush-element');
            }
        } else {
            this.statements.push(statement);
        }
    }
    toJSON() {
        let args = this.arguments;
        let keys = args.map(arg => arg[1]);
        let values = args.map(arg => arg[2]);
        let block = this.selfClosing ? null : {
            statements: this.statements,
            parameters: this.table.slots
        };
        return [this.tag, this.attributes, [keys, values], block];
    }
}
export class Template {
    constructor(symbols) {
        this.block = new TemplateBlock(symbols);
    }
    toJSON() {
        return this.block.toJSON();
    }
}
export default class JavaScriptCompiler {
    constructor(opcodes, symbols, options) {
        this.blocks = new Stack();
        this.values = [];
        this.opcodes = opcodes;
        this.template = new Template(symbols);
        this.options = options;
    }
    static process(opcodes, symbols, options) {
        let compiler = new JavaScriptCompiler(opcodes, symbols, options);
        return compiler.process();
    }
    get currentBlock() {
        return this.blocks.current;
    }
    process() {
        this.opcodes.forEach(op => {
            let opcode = op[0];
            let arg = op[1];
            if (!this[opcode]) {
                throw new Error(`unimplemented ${opcode} on JavaScriptCompiler`);
            }
            this[opcode](arg);
        });
        return this.template;
    }
    /// Nesting
    startBlock(program) {
        let block = new InlineBlock(program['symbols']);
        this.blocks.push(block);
    }
    endBlock() {
        let { template, blocks } = this;
        let block = blocks.pop();
        template.block.blocks.push(block.toJSON());
    }
    startProgram() {
        this.blocks.push(this.template.block);
    }
    endProgram() {}
    /// Statements
    text(content) {
        this.push([Ops.Text, content]);
    }
    append(trusted) {
        this.push([Ops.Append, this.popValue(), trusted]);
    }
    comment(value) {
        this.push([Ops.Comment, value]);
    }
    modifier(name) {
        let params = this.popValue();
        let hash = this.popValue();
        this.push([Ops.Modifier, name, params, hash]);
    }
    block([name, template, inverse]) {
        let params = this.popValue();
        let hash = this.popValue();
        let blocks = this.template.block.blocks;
        (false && assert(typeof template !== 'number' || blocks[template] !== null, 'missing block in the compiler'));
        (false && assert(typeof inverse !== 'number' || blocks[inverse] !== null, 'missing block in the compiler'));

        this.push([Ops.Block, name, params, hash, blocks[template], blocks[inverse]]);
    }
    openComponent(element) {
        let tag = this.options && this.options.customizeComponentName ? this.options.customizeComponentName(element.tag) : element.tag;
        let component = new ComponentBlock(tag, element['symbols'], element.selfClosing);
        this.blocks.push(component);
    }
    openSplattedElement(element) {
        let tag = element.tag;
        if (element.blockParams.length > 0) {
            throw new Error(`Compile Error: <${element.tag}> is not a component and doesn't support block parameters`);
        } else {
            this.push([Ops.OpenSplattedElement, tag]);
        }
    }
    openElement(element) {
        let tag = element.tag;
        if (element.blockParams.length > 0) {
            throw new Error(`Compile Error: <${element.tag}> is not a component and doesn't support block parameters`);
        } else {
            this.push([Ops.OpenElement, tag]);
        }
    }
    flushElement() {
        this.push([Ops.FlushElement]);
    }
    closeComponent(_element) {
        if (_element.modifiers.length > 0) {
            throw new Error('Compile Error: Element modifiers are not allowed in components');
        }
        let [tag, attrs, args, block] = this.endComponent();
        this.push([Ops.Component, tag, attrs, args, block]);
    }
    closeDynamicComponent(_element) {
        let [, attrs, args, block] = this.endComponent();
        this.push([Ops.DynamicComponent, this.popValue(), attrs, args, block]);
    }
    closeElement(_element) {
        this.push([Ops.CloseElement]);
    }
    staticAttr([name, namespace]) {
        let value = this.popValue();
        this.push([Ops.StaticAttr, name, value, namespace]);
    }
    dynamicAttr([name, namespace]) {
        let value = this.popValue();
        this.push([Ops.DynamicAttr, name, value, namespace]);
    }
    componentAttr([name, namespace]) {
        let value = this.popValue();
        this.push([Ops.ComponentAttr, name, value, namespace]);
    }
    trustingAttr([name, namespace]) {
        let value = this.popValue();
        this.push([Ops.TrustingAttr, name, value, namespace]);
    }
    trustingComponentAttr([name, namespace]) {
        let value = this.popValue();
        this.push([Ops.TrustingComponentAttr, name, value, namespace]);
    }
    staticArg(name) {
        let value = this.popValue();
        this.push([Ops.StaticArg, name, value]);
    }
    dynamicArg(name) {
        let value = this.popValue();
        this.push([Ops.DynamicArg, name, value]);
    }
    yield(to) {
        let params = this.popValue();
        this.push([Ops.Yield, to, params]);
    }
    attrSplat(to) {
        // consume (and disregard) the value pushed for the
        // ...attributes attribute
        this.popValue();
        this.push([Ops.AttrSplat, to]);
    }
    debugger(evalInfo) {
        this.push([Ops.Debugger, evalInfo]);
        this.template.block.hasEval = true;
    }
    hasBlock(name) {
        this.pushValue([Ops.HasBlock, name]);
    }
    hasBlockParams(name) {
        this.pushValue([Ops.HasBlockParams, name]);
    }
    partial(evalInfo) {
        let params = this.popValue();
        this.push([Ops.Partial, params[0], evalInfo]);
        this.template.block.hasEval = true;
    }
    /// Expressions
    literal(value) {
        if (value === undefined) {
            this.pushValue([Ops.Undefined]);
        } else {
            this.pushValue(value);
        }
    }
    unknown(name) {
        this.pushValue([Ops.Unknown, name]);
    }
    get([head, path]) {
        this.pushValue([Ops.Get, head, path]);
    }
    maybeLocal(path) {
        this.pushValue([Ops.MaybeLocal, path]);
    }
    concat() {
        this.pushValue([Ops.Concat, this.popValue()]);
    }
    helper(name) {
        let params = this.popValue();
        let hash = this.popValue();
        this.pushValue([Ops.Helper, name, params, hash]);
    }
    /// Stack Management Opcodes
    prepareArray(size) {
        let values = [];
        for (let i = 0; i < size; i++) {
            values.push(this.popValue());
        }
        this.pushValue(values);
    }
    prepareObject(size) {
        (false && assert(this.values.length >= size, `Expected ${size} values on the stack, found ${this.values.length}`));

        let keys = new Array(size);
        let values = new Array(size);
        for (let i = 0; i < size; i++) {
            keys[i] = this.popValue();
            values[i] = this.popValue();
        }
        this.pushValue([keys, values]);
    }
    /// Utilities
    endComponent() {
        let component = this.blocks.pop();
        (false && assert(component instanceof ComponentBlock, 'Compiler bug: endComponent() should end a component'));

        return component.toJSON();
    }
    push(args) {
        while (args[args.length - 1] === null) {
            args.pop();
        }
        this.currentBlock.push(args);
    }
    pushValue(val) {
        this.values.push(val);
    }
    popValue() {
        (false && assert(this.values.length, 'No expression found on stack'));

        return this.values.pop();
    }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiamF2YXNjcmlwdC1jb21waWxlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3BhY2thZ2VzL0BnbGltbWVyL2NvbXBpbGVyL2xpYi9qYXZhc2NyaXB0LWNvbXBpbGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLEFBQU8sU0FBRSxBQUFNLEFBQUUsY0FBTSxBQUFlLEFBQUM7QUFDdkMsQUFBTyxTQUFFLEFBQUssT0FBRSxBQUFPLEFBQVUsQUFBTSxBQUFFLGVBQU0sQUFBZSxBQUFDO0FBSS9ELEFBQU8sU0FRTCxBQUFHLEtBQ0gsQUFBYyxnQkFDZCxBQUFVLFlBQ1YsQUFBVyxBQUNaLG1CQUFNLEFBQXNCLEFBQUM7QUFTOUIsQUFBTSxhQUFnQixBQUFLO0FBQTNCO0FBQ1MsYUFBVSxhQUFnQixBQUFFLEFBQUMsQUFPdEM7QUFBQztBQUhDLEFBQUksU0FBQyxBQUFvQjtBQUN2QixBQUFJLGFBQUMsQUFBVSxXQUFDLEFBQUksS0FBQyxBQUFTLEFBQUMsQUFBQyxBQUNsQztBQUFDLEFBQ0Y7O0FBRUQsQUFBTSxhQUFPLEFBQVksb0JBQVEsQUFBSztBQUNwQyxnQkFBbUIsQUFBdUI7QUFDeEMsQUFBSyxBQUFFLEFBQUM7QUFEUyxhQUFLLFFBQUwsQUFBSyxBQUFrQixBQUUxQztBQUFDO0FBRUQsQUFBTTtBQUNKO0FBQ0UsQUFBVSx3QkFBRSxBQUFJLEtBQUMsQUFBVTtBQUMzQixBQUFVLHdCQUFFLEFBQUksS0FBQyxBQUFLLE1BQUMsQUFBSyxBQUM3QixBQUFDLEFBQ0o7QUFKUztBQUlSLEFBQ0Y7O0FBRUQsQUFBTSxhQUFPLEFBQWMsc0JBQVEsQUFBSztBQU90QyxnQkFBb0IsQUFBK0I7QUFDakQsQUFBSyxBQUFFLEFBQUM7QUFEVSxhQUFXLGNBQVgsQUFBVyxBQUFvQjtBQU41QyxhQUFJLE9BQUcsQUFBVSxBQUFDO0FBQ2xCLGFBQU0sU0FBRyxJQUFJLEFBQU8sQUFBVSxBQUFDO0FBQy9CLGFBQUssUUFBRyxJQUFJ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QUksaUJBQUMsQUFBRyxBQUFFLEFBQUM7QUFDWjtBQUVELEFBQUksYUFBQyxBQUFZLGFBQUMsQUFBSSxLQUFDLEFBQUksQUFBQyxBQUFDLEFBQy9CO0FBQUM7QUFFRCxBQUFTLGNBQXVDLEFBQU07QUFDcEQsQUFBSSxhQUFDLEFBQU0sT0FBQyxBQUFJLEtBQUMsQUFBRyxBQUFDLEFBQUMsQUFDeEI7QUFBQztBQUVELEFBQVE7a0JBQ04sQUFBTSxPQUFDLEFBQUksS0FBQyxBQUFNLE9BQUMsQUFBTSxRQUFFLEFBQThCLEFBQUMsQUFBQzs7QUFDM0QsZUFBTyxBQUFJLEtBQUMsQUFBTSxPQUFDLEFBQUcsQUFBTyxBQUFDLEFBQ2hDO0FBQUMsQUFDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGFzc2VydCB9IGZyb20gJ0BnbGltbWVyL3V0aWwnO1xuaW1wb3J0IHsgU3RhY2ssIERpY3RTZXQsIE9wdGlvbiwgZXhwZWN0IH0gZnJvbSAnQGdsaW1tZXIvdXRpbCc7XG5pbXBvcnQgeyBBU1QgfSBmcm9tICdAZ2xpbW1lci9zeW50YXgnO1xuaW1wb3J0IHsgQmxvY2tTeW1ib2xUYWJsZSwgUHJvZ3JhbVN5bWJvbFRhYmxlIH0gZnJvbSAnLi90ZW1wbGF0ZS12aXNpdG9yJztcbmltcG9ydCB7IENvbXBpbGVPcHRpb25zIH0gZnJvbSAnLi90ZW1wbGF0ZS1jb21waWxlcic7XG5pbXBvcnQge1xuICBTZXJpYWxpemVkSW5saW5lQmxvY2ssXG4gIFNlcmlhbGl6ZWRUZW1wbGF0ZUJsb2NrLFxuICBDb3JlLFxuICBTdGF0ZW1lbnQsXG4gIFN0YXRlbWVudHMsXG4gIEV4cHJlc3Npb24sXG4gIEV4cHJlc3Npb25zLFxuICBPcHMsXG4gIGlzRmx1c2hFbGVtZW50LFxuICBpc0FyZ3VtZW50LFxuICBpc0F0dHJpYnV0ZSxcbn0gZnJvbSAnQGdsaW1tZXIvd2lyZS1mb3JtYXQnO1xuaW1wb3J0IHsgUHJvY2Vzc29yLCBDb21waWxlck9wcywgT3BOYW1lLCBPcCB9IGZyb20gJy4vY29tcGlsZXItb3BzJztcblxuZXhwb3J0IHR5cGUgc3RyID0gc3RyaW5nO1xuZXhwb3J0IHR5cGUgUGFyYW1zID0gQ29yZS5QYXJhbXM7XG5leHBvcnQgdHlwZSBIYXNoID0gQ29yZS5IYXNoO1xuZXhwb3J0IHR5cGUgUGF0aCA9IENvcmUuUGF0aDtcbmV4cG9ydCB0eXBlIFN0YWNrVmFsdWUgPSBFeHByZXNzaW9uIHwgUGFyYW1zIHwgSGFzaCB8IHN0cjtcblxuZXhwb3J0IGFic3RyYWN0IGNsYXNzIEJsb2NrIHtcbiAgcHVibGljIHN0YXRlbWVudHM6IFN0YXRlbWVudFtdID0gW107XG5cbiAgYWJzdHJhY3QgdG9KU09OKCk6IE9iamVjdDtcblxuICBwdXNoKHN0YXRlbWVudDogU3RhdGVtZW50KSB7XG4gICAgdGhpcy5zdGF0ZW1lbnRzLnB1c2goc3RhdGVtZW50KTtcbiAgfVxufVxuXG5leHBvcnQgY2xhc3MgSW5saW5lQmxvY2sgZXh0ZW5kcyBCbG9jayB7XG4gIGNvbnN0cnVjdG9yKHB1YmxpYyB0YWJsZTogQmxvY2tTeW1ib2xUYWJsZSkge1xuICAgIHN1cGVyKCk7XG4gIH1cblxuICB0b0pTT04oKTogU2VyaWFsaXplZElubGluZUJsb2NrIHtcbiAgICByZXR1cm4ge1xuICAgICAgc3RhdGVtZW50czogdGhpcy5zdGF0ZW1lbnRzLFxuICAgICAgcGFyYW1ldGVyczogdGhpcy50YWJsZS5zbG90cyxcbiAgICB9O1xuICB9XG59XG5cbmV4cG9ydCBjbGFzcyBUZW1wbGF0ZUJsb2NrIGV4dGVuZHMgQmxvY2sge1xuICBwdWJsaWMgdHlwZSA9ICd0ZW1wbGF0ZSc7XG4gIHB1YmxpYyB5aWVsZHMgPSBuZXcgRGljdFNldDxzdHJpbmc+KCk7XG4gIHB1YmxpYyBuYW1lZCA9IG5ldyBEaWN0U2V0PHN0cmluZz4oKTtcbiAgcHVibGljIGJsb2NrczogU2VyaWFsaXplZElubGluZUJsb2NrW10gPSBbXTtcbiAgcHVibGljIGhhc0V2YWwgPSBmYWxzZTtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHN5bWJvbFRhYmxlOiBQcm9ncmFtU3ltYm9sVGFibGUpIHtcbiAgICBzdXBlcigpO1xuICB9XG5cbiAgcHVzaChzdGF0ZW1lbnQ6IFN0YXRlbWVudCkge1xuICAgIHRoaXMuc3RhdGVtZW50cy5wdXNoKHN0YXRlbWVudCk7XG4gIH1cblxuICB0b0pTT04oKTogU2VyaWFsaXplZFRlbXBsYXRlQmxvY2sge1xuICAgIHJldHVybiB7XG4gICAgICBzeW1ib2xzOiB0aGlzLnN5bWJvbFRhYmxlLnN5bWJvbHMsXG4gICAgICBzdGF0ZW1lbnRzOiB0aGlzLnN0YXRlbWVudHMsXG4gICAgICBoYXNFdmFsOiB0aGlzLmhhc0V2YWwsXG4gICAgfTtcbiAgfVxufVxuXG5leHBvcnQgY2xhc3MgQ29tcG9uZW50QmxvY2sgZXh0ZW5kcyBCbG9jayB7XG4gIHB1YmxpYyBhdHRyaWJ1dGVzOiBTdGF0ZW1lbnRzLkF0dHJpYnV0ZVtdID0gW107XG4gIHB1YmxpYyBhcmd1bWVudHM6IFN0YXRlbWVudHMuQXJndW1lbnRbXSA9IFtdO1xuICBwcml2YXRlIGluUGFyYW1zID0gdHJ1ZTtcbiAgcHVibGljIHBvc2l0aW9uYWxzOiBudW1iZXJbXSA9IFtdO1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgdGFnOiBzdHJpbmcsIHByaXZhdGUgdGFibGU6IEJsb2NrU3ltYm9sVGFibGUsIHByaXZhdGUgc2VsZkNsb3Npbmc6IGJvb2xlYW4pIHtcbiAgICBzdXBlcigpO1xuICB9XG5cbiAgcHVzaChzdGF0ZW1lbnQ6IFN0YXRlbWVudCkge1xuICAgIGlmICh0aGlzLmluUGFyYW1zKSB7XG4gICAgICBpZiAoaXNGbHVzaEVsZW1lbnQoc3RhdGVtZW50KSkge1xuICAgICAgICB0aGlzLmluUGFyYW1zID0gZmFsc2U7XG4gICAgICB9IGVsc2UgaWYgKGlzQXJndW1lbnQoc3RhdGVtZW50KSkge1xuICAgICAgICB0aGlzLmFyZ3VtZW50cy5wdXNoKHN0YXRlbWVudCk7XG4gICAgICB9IGVsc2UgaWYgKGlzQXR0cmlidXRlKHN0YXRlbWVudCkpIHtcbiAgICAgICAgdGhpcy5hdHRyaWJ1dGVzLnB1c2goc3RhdGVtZW50KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignQ29tcGlsZSBFcnJvcjogb25seSBwYXJhbWV0ZXJzIGFsbG93ZWQgYmVmb3JlIGZsdXNoLWVsZW1lbnQnKTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5zdGF0ZW1lbnRzLnB1c2goc3RhdGVtZW50KTtcbiAgICB9XG4gIH1cblxuICB0b0pTT04oKTogW3N0cmluZywgU3RhdGVtZW50cy5BdHRyaWJ1dGVbXSwgQ29yZS5IYXNoLCBPcHRpb248U2VyaWFsaXplZElubGluZUJsb2NrPl0ge1xuICAgIGxldCBhcmdzID0gdGhpcy5hcmd1bWVudHM7XG4gICAgbGV0IGtleXMgPSBhcmdzLm1hcChhcmcgPT4gYXJnWzFdKTtcbiAgICBsZXQgdmFsdWVzID0gYXJncy5tYXAoYXJnID0+IGFyZ1syXSk7XG4gICAgbGV0IGJsb2NrID0gdGhpcy5zZWxmQ2xvc2luZ1xuICAgICAgPyBudWxsXG4gICAgICA6IHtcbiAgICAgICAgICBzdGF0ZW1lbnRzOiB0aGlzLnN0YXRlbWVudHMsXG4gICAgICAgICAgcGFyYW1ldGVyczogdGhpcy50YWJsZS5zbG90cyxcbiAgICAgICAgfTtcblxuICAgIHJldHVybiBbdGhpcy50YWcsIHRoaXMuYXR0cmlidXRlcywgW2tleXMsIHZhbHVlc10sIGJsb2NrXTtcbiAgfVxufVxuXG5leHBvcnQgY2xhc3MgVGVtcGxhdGUge1xuICBwdWJsaWMgYmxvY2s6IFRlbXBsYXRlQmxvY2s7XG5cbiAgY29uc3RydWN0b3Ioc3ltYm9sczogUHJvZ3JhbVN5bWJvbFRhYmxlKSB7XG4gICAgdGhpcy5ibG9jayA9IG5ldyBUZW1wbGF0ZUJsb2NrKHN5bWJvbHMpO1xuICB9XG5cbiAgdG9KU09OKCk6IFNlcmlhbGl6ZWRUZW1wbGF0ZUJsb2NrIHtcbiAgICByZXR1cm4gdGhpcy5ibG9jay50b0pTT04oKTtcbiAgfVxufVxuXG5leHBvcnQgdHlwZSBJblZhcmlhYmxlID0gbnVtYmVyO1xuZXhwb3J0IHR5cGUgSW5PcDxLIGV4dGVuZHMga2V5b2YgQ29tcGlsZXJPcHM8SW5WYXJpYWJsZT4gPSBPcE5hbWU+ID0gT3A8XG4gIEluVmFyaWFibGUsXG4gIENvbXBpbGVyT3BzPEluVmFyaWFibGU+LFxuICBLXG4+O1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBKYXZhU2NyaXB0Q29tcGlsZXJcbiAgaW1wbGVtZW50cyBQcm9jZXNzb3I8Q29tcGlsZXJPcHM8bnVtYmVyPiwgdm9pZCwgQ29tcGlsZXJPcHM8dm9pZD4+IHtcbiAgc3RhdGljIHByb2Nlc3Mob3Bjb2RlczogSW5PcFtdLCBzeW1ib2xzOiBQcm9ncmFtU3ltYm9sVGFibGUsIG9wdGlvbnM/OiBDb21waWxlT3B0aW9ucyk6IFRlbXBsYXRlIHtcbiAgICBsZXQgY29tcGlsZXIgPSBuZXcgSmF2YVNjcmlwdENvbXBpbGVyKG9wY29kZXMsIHN5bWJvbHMsIG9wdGlvbnMpO1xuICAgIHJldHVybiBjb21waWxlci5wcm9jZXNzKCk7XG4gIH1cblxuICBwcml2YXRlIHRlbXBsYXRlOiBUZW1wbGF0ZTtcbiAgcHJpdmF0ZSBibG9ja3MgPSBuZXcgU3RhY2s8QmxvY2s+KCk7XG4gIHByaXZhdGUgb3Bjb2RlczogSW5PcFtdO1xuICBwcml2YXRlIHZhbHVlczogU3RhY2tWYWx1ZVtdID0gW107XG4gIHByaXZhdGUgb3B0aW9uczogQ29tcGlsZU9wdGlvbnMgfCB1bmRlZmluZWQ7XG5cbiAgY29uc3RydWN0b3Iob3Bjb2RlczogSW5PcFtdLCBzeW1ib2xzOiBQcm9ncmFtU3ltYm9sVGFibGUsIG9wdGlvbnM/OiBDb21waWxlT3B0aW9ucykge1xuICAgIHRoaXMub3Bjb2RlcyA9IG9wY29kZXM7XG4gICAgdGhpcy50ZW1wbGF0ZSA9IG5ldyBUZW1wbGF0ZShzeW1ib2xzKTtcbiAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zO1xuICB9XG5cbiAgZ2V0IGN1cnJlbnRCbG9jaygpOiBCbG9jayB7XG4gICAgcmV0dXJuIGV4cGVjdCh0aGlzLmJsb2Nrcy5jdXJyZW50LCAnRXhwZWN0ZWQgYSBibG9jayBvbiB0aGUgc3RhY2snKTtcbiAgfVxuXG4gIHByb2Nlc3MoKTogVGVtcGxhdGUge1xuICAgIHRoaXMub3Bjb2Rlcy5mb3JFYWNoKG9wID0+IHtcbiAgICAgIGxldCBvcGNvZGUgPSBvcFswXTtcbiAgICAgIGxldCBhcmcgPSBvcFsxXTtcblxuICAgICAgaWYgKCF0aGlzW29wY29kZV0pIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGB1bmltcGxlbWVudGVkICR7b3Bjb2RlfSBvbiBKYXZhU2NyaXB0Q29tcGlsZXJgKTtcbiAgICAgIH1cbiAgICAgICh0aGlzW29wY29kZV0gYXMgYW55KShhcmcpO1xuICAgIH0pO1xuXG4gICAgcmV0dXJuIHRoaXMudGVtcGxhdGU7XG4gIH1cblxuICAvLy8gTmVzdGluZ1xuXG4gIHN0YXJ0QmxvY2socHJvZ3JhbTogQVNULlByb2dyYW0pIHtcbiAgICBsZXQgYmxvY2s6IEJsb2NrID0gbmV3IElubGluZUJsb2NrKHByb2dyYW1bJ3N5bWJvbHMnXSk7XG4gICAgdGhpcy5ibG9ja3MucHVzaChibG9jayk7XG4gIH1cblxuICBlbmRCbG9jaygpIHtcbiAgICBsZXQgeyB0ZW1wbGF0ZSwgYmxvY2tzIH0gPSB0aGlzO1xuICAgIGxldCBibG9jayA9IGJsb2Nrcy5wb3AoKSBhcyBJbmxpbmVCbG9jaztcbiAgICB0ZW1wbGF0ZS5ibG9jay5ibG9ja3MucHVzaChibG9jay50b0pTT04oKSk7XG4gIH1cblxuICBzdGFydFByb2dyYW0oKSB7XG4gICAgdGhpcy5ibG9ja3MucHVzaCh0aGlzLnRlbXBsYXRlLmJsb2NrKTtcbiAgfVxuXG4gIGVuZFByb2dyYW0oKSB7fVxuXG4gIC8vLyBTdGF0ZW1lbnRzXG5cbiAgdGV4dChjb250ZW50OiBzdHJpbmcpIHtcbiAgICB0aGlzLnB1c2goW09wcy5UZXh0LCBjb250ZW50XSk7XG4gIH1cblxuICBhcHBlbmQodHJ1c3RlZDogYm9vbGVhbikge1xuICAgIHRoaXMucHVzaChbT3BzLkFwcGVuZCwgdGhpcy5wb3BWYWx1ZTxFeHByZXNzaW9uPigpLCB0cnVzdGVkXSk7XG4gIH1cblxuICBjb21tZW50KHZhbHVlOiBzdHJpbmcpIHtcbiAgICB0aGlzLnB1c2goW09wcy5Db21tZW50LCB2YWx1ZV0pO1xuICB9XG5cbiAgbW9kaWZpZXIobmFtZTogc3RyaW5nKSB7XG4gICAgbGV0IHBhcmFtcyA9IHRoaXMucG9wVmFsdWU8UGFyYW1zPigpO1xuICAgIGxldCBoYXNoID0gdGhpcy5wb3BWYWx1ZTxIYXNoPigpO1xuXG4gICAgdGhpcy5wdXNoKFtPcHMuTW9kaWZpZXIsIG5hbWUsIHBhcmFtcywgaGFzaF0pO1xuICB9XG5cbiAgYmxvY2soW25hbWUsIHRlbXBsYXRlLCBpbnZlcnNlXTogW3N0cmluZywgbnVtYmVyLCBPcHRpb248bnVtYmVyPl0pIHtcbiAgICBsZXQgcGFyYW1zID0gdGhpcy5wb3BWYWx1ZTxQYXJhbXM+KCk7XG4gICAgbGV0IGhhc2ggPSB0aGlzLnBvcFZhbHVlPEhhc2g+KCk7XG5cbiAgICBsZXQgYmxvY2tzID0gdGhpcy50ZW1wbGF0ZS5ibG9jay5ibG9ja3M7XG4gICAgYXNzZXJ0KFxuICAgICAgdHlwZW9mIHRlbXBsYXRlICE9PSAnbnVtYmVyJyB8fCBibG9ja3NbdGVtcGxhdGVdICE9PSBudWxsLFxuICAgICAgJ21pc3NpbmcgYmxvY2sgaW4gdGhlIGNvbXBpbGVyJ1xuICAgICk7XG4gICAgYXNzZXJ0KFxuICAgICAgdHlwZW9mIGludmVyc2UgIT09ICdudW1iZXInIHx8IGJsb2Nrc1tpbnZlcnNlXSAhPT0gbnVsbCxcbiAgICAgICdtaXNzaW5nIGJsb2NrIGluIHRoZSBjb21waWxlcidcbiAgICApO1xuXG4gICAgdGhpcy5wdXNoKFtPcHMuQmxvY2ssIG5hbWUsIHBhcmFtcywgaGFzaCwgYmxvY2tzW3RlbXBsYXRlXSwgYmxvY2tzW2ludmVyc2UhXV0pO1xuICB9XG5cbiAgb3BlbkNvbXBvbmVudChlbGVtZW50OiBBU1QuRWxlbWVudE5vZGUpIHtcbiAgICBsZXQgdGFnID1cbiAgICAgIHRoaXMub3B0aW9ucyAmJiB0aGlzLm9wdGlvbnMuY3VzdG9taXplQ29tcG9uZW50TmFtZVxuICAgICAgICA/IHRoaXMub3B0aW9ucy5jdXN0b21pemVDb21wb25lbnROYW1lKGVsZW1lbnQudGFnKVxuICAgICAgICA6IGVsZW1lbnQudGFnO1xuICAgIGxldCBjb21wb25lbnQgPSBuZXcgQ29tcG9uZW50QmxvY2sodGFnLCBlbGVtZW50WydzeW1ib2xzJ10sIGVsZW1lbnQuc2VsZkNsb3NpbmcpO1xuICAgIHRoaXMuYmxvY2tzLnB1c2goY29tcG9uZW50KTtcbiAgfVxuXG4gIG9wZW5TcGxhdHRlZEVsZW1lbnQoZWxlbWVudDogQVNULkVsZW1lbnROb2RlKSB7XG4gICAgbGV0IHRhZyA9IGVsZW1lbnQudGFnO1xuXG4gICAgaWYgKGVsZW1lbnQuYmxvY2tQYXJhbXMubGVuZ3RoID4gMCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgQ29tcGlsZSBFcnJvcjogPCR7ZWxlbWVudC50YWd9PiBpcyBub3QgYSBjb21wb25lbnQgYW5kIGRvZXNuJ3Qgc3VwcG9ydCBibG9jayBwYXJhbWV0ZXJzYFxuICAgICAgKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5wdXNoKFtPcHMuT3BlblNwbGF0dGVkRWxlbWVudCwgdGFnXSk7XG4gICAgfVxuICB9XG5cbiAgb3BlbkVsZW1lbnQoZWxlbWVudDogQVNULkVsZW1lbnROb2RlKSB7XG4gICAgbGV0IHRhZyA9IGVsZW1lbnQudGFnO1xuXG4gICAgaWYgKGVsZW1lbnQuYmxvY2tQYXJhbXMubGVuZ3RoID4gMCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgQ29tcGlsZSBFcnJvcjogPCR7ZWxlbWVudC50YWd9PiBpcyBub3QgYSBjb21wb25lbnQgYW5kIGRvZXNuJ3Qgc3VwcG9ydCBibG9jayBwYXJhbWV0ZXJzYFxuICAgICAgKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5wdXNoKFtPcHMuT3BlbkVsZW1lbnQsIHRhZ10pO1xuICAgIH1cbiAgfVxuXG4gIGZsdXNoRWxlbWVudCgpIHtcbiAgICB0aGlzLnB1c2goW09wcy5GbHVzaEVsZW1lbnRdKTtcbiAgfVxuXG4gIGNsb3NlQ29tcG9uZW50KF9lbGVtZW50OiBBU1QuRWxlbWVudE5vZGUpIHtcbiAgICBpZiAoX2VsZW1lbnQubW9kaWZpZXJzLmxlbmd0aCA+IDApIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignQ29tcGlsZSBFcnJvcjogRWxlbWVudCBtb2RpZmllcnMgYXJlIG5vdCBhbGxvd2VkIGluIGNvbXBvbmVudHMnKTtcbiAgICB9XG4gICAgbGV0IFt0YWcsIGF0dHJzLCBhcmdzLCBibG9ja10gPSB0aGlzLmVuZENvbXBvbmVudCgpO1xuXG4gICAgdGhpcy5wdXNoKFtPcHMuQ29tcG9uZW50LCB0YWcsIGF0dHJzLCBhcmdzLCBibG9ja10pO1xuICB9XG5cbiAgY2xvc2VEeW5hbWljQ29tcG9uZW50KF9lbGVtZW50OiBBU1QuRWxlbWVudE5vZGUpIHtcbiAgICBsZXQgWywgYXR0cnMsIGFyZ3MsIGJsb2NrXSA9IHRoaXMuZW5kQ29tcG9uZW50KCk7XG5cbiAgICB0aGlzLnB1c2goW09wcy5EeW5hbWljQ29tcG9uZW50LCB0aGlzLnBvcFZhbHVlPEV4cHJlc3Npb24+KCksIGF0dHJzLCBhcmdzLCBibG9ja10pO1xuICB9XG5cbiAgY2xvc2VFbGVtZW50KF9lbGVtZW50OiBBU1QuRWxlbWVudE5vZGUpIHtcbiAgICB0aGlzLnB1c2goW09wcy5DbG9zZUVsZW1lbnRdKTtcbiAgfVxuXG4gIHN0YXRpY0F0dHIoW25hbWUsIG5hbWVzcGFjZV06IFtzdHJpbmcsIE9wdGlvbjxzdHJpbmc+XSkge1xuICAgIGxldCB2YWx1ZSA9IHRoaXMucG9wVmFsdWU8RXhwcmVzc2lvbj4oKTtcbiAgICB0aGlzLnB1c2goW09wcy5TdGF0aWNBdHRyLCBuYW1lLCB2YWx1ZSwgbmFtZXNwYWNlXSk7XG4gIH1cblxuICBkeW5hbWljQXR0cihbbmFtZSwgbmFtZXNwYWNlXTogW3N0cmluZywgT3B0aW9uPHN0cmluZz5dKSB7XG4gICAgbGV0IHZhbHVlID0gdGhpcy5wb3BWYWx1ZTxFeHByZXNzaW9uPigpO1xuICAgIHRoaXMucHVzaChbT3BzLkR5bmFtaWNBdHRyLCBuYW1lLCB2YWx1ZSwgbmFtZXNwYWNlXSk7XG4gIH1cblxuICBjb21wb25lbnRBdHRyKFtuYW1lLCBuYW1lc3BhY2VdOiBbc3RyaW5nLCBPcHRpb248c3RyaW5nPl0pIHtcbiAgICBsZXQgdmFsdWUgPSB0aGlzLnBvcFZhbHVlPEV4cHJlc3Npb24+KCk7XG4gICAgdGhpcy5wdXNoKFtPcHMuQ29tcG9uZW50QXR0ciwgbmFtZSwgdmFsdWUsIG5hbWVzcGFjZV0pO1xuICB9XG5cbiAgdHJ1c3RpbmdBdHRyKFtuYW1lLCBuYW1lc3BhY2VdOiBbc3RyaW5nLCBPcHRpb248c3RyaW5nPl0pIHtcbiAgICBsZXQgdmFsdWUgPSB0aGlzLnBvcFZhbHVlPEV4cHJlc3Npb24+KCk7XG4gICAgdGhpcy5wdXNoKFtPcHMuVHJ1c3RpbmdBdHRyLCBuYW1lLCB2YWx1ZSwgbmFtZXNwYWNlIV0pO1xuICB9XG5cbiAgdHJ1c3RpbmdDb21wb25lbnRBdHRyKFtuYW1lLCBuYW1lc3BhY2VdOiBbc3RyaW5nLCBPcHRpb248c3RyaW5nPl0pIHtcbiAgICBsZXQgdmFsdWUgPSB0aGlzLnBvcFZhbHVlPEV4cHJlc3Npb24+KCk7XG4gICAgdGhpcy5wdXNoKFtPcHMuVHJ1c3RpbmdDb21wb25lbnRBdHRyLCBuYW1lLCB2YWx1ZSwgbmFtZXNwYWNlIV0pO1xuICB9XG5cbiAgc3RhdGljQXJnKG5hbWU6IHN0cikge1xuICAgIGxldCB2YWx1ZSA9IHRoaXMucG9wVmFsdWU8RXhwcmVzc2lvbj4oKTtcbiAgICB0aGlzLnB1c2goW09wcy5TdGF0aWNBcmcsIG5hbWUsIHZhbHVlXSk7XG4gIH1cblxuICBkeW5hbWljQXJnKG5hbWU6IHN0cikge1xuICAgIGxldCB2YWx1ZSA9IHRoaXMucG9wVmFsdWU8RXhwcmVzc2lvbj4oKTtcbiAgICB0aGlzLnB1c2goW09wcy5EeW5hbWljQXJnLCBuYW1lLCB2YWx1ZV0pO1xuICB9XG5cbiAgeWllbGQodG86IG51bWJlcikge1xuICAgIGxldCBwYXJhbXMgPSB0aGlzLnBvcFZhbHVlPFBhcmFtcz4oKTtcbiAgICB0aGlzLnB1c2goW09wcy5ZaWVsZCwgdG8sIHBhcmFtc10pO1xuICB9XG5cbiAgYXR0clNwbGF0KHRvOiBPcHRpb248bnVtYmVyPikge1xuICAgIC8vIGNvbnN1bWUgKGFuZCBkaXNyZWdhcmQpIHRoZSB2YWx1ZSBwdXNoZWQgZm9yIHRoZVxuICAgIC8vIC4uLmF0dHJpYnV0ZXMgYXR0cmlidXRlXG4gICAgdGhpcy5wb3BWYWx1ZSgpO1xuICAgIHRoaXMucHVzaChbT3BzLkF0dHJTcGxhdCwgdG8hXSk7XG4gIH1cblxuICBkZWJ1Z2dlcihldmFsSW5mbzogT3B0aW9uPENvcmUuRXZhbEluZm8+KSB7XG4gICAgdGhpcy5wdXNoKFtPcHMuRGVidWdnZXIsIGV2YWxJbmZvIV0pO1xuICAgIHRoaXMudGVtcGxhdGUuYmxvY2suaGFzRXZhbCA9IHRydWU7XG4gIH1cblxuICBoYXNCbG9jayhuYW1lOiBudW1iZXIpIHtcbiAgICB0aGlzLnB1c2hWYWx1ZTxFeHByZXNzaW9ucy5IYXNCbG9jaz4oW09wcy5IYXNCbG9jaywgbmFtZV0pO1xuICB9XG5cbiAgaGFzQmxvY2tQYXJhbXMobmFtZTogbnVtYmVyKSB7XG4gICAgdGhpcy5wdXNoVmFsdWU8RXhwcmVzc2lvbnMuSGFzQmxvY2tQYXJhbXM+KFtPcHMuSGFzQmxvY2tQYXJhbXMsIG5hbWVdKTtcbiAgfVxuXG4gIHBhcnRpYWwoZXZhbEluZm86IE9wdGlvbjxDb3JlLkV2YWxJbmZvPikge1xuICAgIGxldCBwYXJhbXMgPSB0aGlzLnBvcFZhbHVlPFBhcmFtcz4oKTtcbiAgICB0aGlzLnB1c2goW09wcy5QYXJ0aWFsLCBwYXJhbXNbMF0sIGV2YWxJbmZvIV0pO1xuICAgIHRoaXMudGVtcGxhdGUuYmxvY2suaGFzRXZhbCA9IHRydWU7XG4gIH1cblxuICAvLy8gRXhwcmVzc2lvbnNcblxuICBsaXRlcmFsKHZhbHVlOiBFeHByZXNzaW9ucy5WYWx1ZSB8IHVuZGVmaW5lZCkge1xuICAgIGlmICh2YWx1ZSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICB0aGlzLnB1c2hWYWx1ZTxFeHByZXNzaW9ucy5VbmRlZmluZWQ+KFtPcHMuVW5kZWZpbmVkXSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMucHVzaFZhbHVlPEV4cHJlc3Npb25zLlZhbHVlPih2YWx1ZSk7XG4gICAgfVxuICB9XG5cbiAgdW5rbm93bihuYW1lOiBzdHJpbmcpIHtcbiAgICB0aGlzLnB1c2hWYWx1ZTxFeHByZXNzaW9ucy5Vbmtub3duPihbT3BzLlVua25vd24sIG5hbWVdKTtcbiAgfVxuXG4gIGdldChbaGVhZCwgcGF0aF06IFtudW1iZXIsIHN0cmluZ1tdXSkge1xuICAgIHRoaXMucHVzaFZhbHVlPEV4cHJlc3Npb25zLkdldD4oW09wcy5HZXQsIGhlYWQsIHBhdGhdKTtcbiAgfVxuXG4gIG1heWJlTG9jYWwocGF0aDogc3RyaW5nW10pIHtcbiAgICB0aGlzLnB1c2hWYWx1ZTxFeHByZXNzaW9ucy5NYXliZUxvY2FsPihbT3BzLk1heWJlTG9jYWwsIHBhdGhdKTtcbiAgfVxuXG4gIGNvbmNhdCgpIHtcbiAgICB0aGlzLnB1c2hWYWx1ZTxFeHByZXNzaW9ucy5Db25jYXQ+KFtPcHMuQ29uY2F0LCB0aGlzLnBvcFZhbHVlPFBhcmFtcz4oKV0pO1xuICB9XG5cbiAgaGVscGVyKG5hbWU6IHN0cmluZykge1xuICAgIGxldCBwYXJhbXMgPSB0aGlzLnBvcFZhbHVlPFBhcmFtcz4oKTtcbiAgICBsZXQgaGFzaCA9IHRoaXMucG9wVmFsdWU8SGFzaD4oKTtcblxuICAgIHRoaXMucHVzaFZhbHVlPEV4cHJlc3Npb25zLkhlbHBlcj4oW09wcy5IZWxwZXIsIG5hbWUsIHBhcmFtcywgaGFzaF0pO1xuICB9XG5cbiAgLy8vIFN0YWNrIE1hbmFnZW1lbnQgT3Bjb2Rlc1xuXG4gIHByZXBhcmVBcnJheShzaXplOiBudW1iZXIpIHtcbiAgICBsZXQgdmFsdWVzOiBFeHByZXNzaW9uW10gPSBbXTtcblxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc2l6ZTsgaSsrKSB7XG4gICAgICB2YWx1ZXMucHVzaCh0aGlzLnBvcFZhbHVlKCkgYXMgRXhwcmVzc2lvbik7XG4gICAgfVxuXG4gICAgdGhpcy5wdXNoVmFsdWU8UGFyYW1zPih2YWx1ZXMpO1xuICB9XG5cbiAgcHJlcGFyZU9iamVjdChzaXplOiBudW1iZXIpIHtcbiAgICBhc3NlcnQoXG4gICAgICB0aGlzLnZhbHVlcy5sZW5ndGggPj0gc2l6ZSxcbiAgICAgIGBFeHBlY3RlZCAke3NpemV9IHZhbHVlcyBvbiB0aGUgc3RhY2ssIGZvdW5kICR7dGhpcy52YWx1ZXMubGVuZ3RofWBcbiAgICApO1xuXG4gICAgbGV0IGtleXM6IHN0cmluZ1tdID0gbmV3IEFycmF5KHNpemUpO1xuICAgIGxldCB2YWx1ZXM6IEV4cHJlc3Npb25bXSA9IG5ldyBBcnJheShzaXplKTtcblxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc2l6ZTsgaSsrKSB7XG4gICAgICBrZXlzW2ldID0gdGhpcy5wb3BWYWx1ZTxzdHI+KCk7XG4gICAgICB2YWx1ZXNbaV0gPSB0aGlzLnBvcFZhbHVlPEV4cHJlc3Npb24+KCk7XG4gICAgfVxuXG4gICAgdGhpcy5wdXNoVmFsdWU8SGFzaD4oW2tleXMsIHZhbHVlc10pO1xuICB9XG5cbiAgLy8vIFV0aWxpdGllc1xuXG4gIGVuZENvbXBvbmVudCgpOiBbc3RyaW5nLCBTdGF0ZW1lbnRzLkF0dHJpYnV0ZVtdLCBDb3JlLkhhc2gsIE9wdGlvbjxTZXJpYWxpemVkSW5saW5lQmxvY2s+XSB7XG4gICAgbGV0IGNvbXBvbmVudCA9IHRoaXMuYmxvY2tzLnBvcCgpO1xuICAgIGFzc2VydChcbiAgICAgIGNvbXBvbmVudCBpbnN0YW5jZW9mIENvbXBvbmVudEJsb2NrLFxuICAgICAgJ0NvbXBpbGVyIGJ1ZzogZW5kQ29tcG9uZW50KCkgc2hvdWxkIGVuZCBhIGNvbXBvbmVudCdcbiAgICApO1xuXG4gICAgcmV0dXJuIChjb21wb25lbnQgYXMgQ29tcG9uZW50QmxvY2spLnRvSlNPTigpO1xuICB9XG5cbiAgcHVzaChhcmdzOiBTdGF0ZW1lbnQpIHtcbiAgICB3aGlsZSAoYXJnc1thcmdzLmxlbmd0aCAtIDFdID09PSBudWxsKSB7XG4gICAgICBhcmdzLnBvcCgpO1xuICAgIH1cblxuICAgIHRoaXMuY3VycmVudEJsb2NrLnB1c2goYXJncyk7XG4gIH1cblxuICBwdXNoVmFsdWU8UyBleHRlbmRzIEV4cHJlc3Npb24gfCBQYXJhbXMgfCBIYXNoPih2YWw6IFMpIHtcbiAgICB0aGlzLnZhbHVlcy5wdXNoKHZhbCk7XG4gIH1cblxuICBwb3BWYWx1ZTxUIGV4dGVuZHMgU3RhY2tWYWx1ZT4oKTogVCB7XG4gICAgYXNzZXJ0KHRoaXMudmFsdWVzLmxlbmd0aCwgJ05vIGV4cHJlc3Npb24gZm91bmQgb24gc3RhY2snKTtcbiAgICByZXR1cm4gdGhpcy52YWx1ZXMucG9wKCkgYXMgVDtcbiAgfVxufVxuIl19